<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>Pedidos - Deco-Racks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Web Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Ubuntu:wght@500;700&display=swap"
    rel="stylesheet">

  <!-- Icon Font Stylesheet -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Libraries Stylesheet -->
  <link th:href="@{animate/animate.min.css}" rel="stylesheet">

  <!-- Customized Bootstrap Stylesheet -->
  <link th:href="@{css/bootstrap.css}" rel="stylesheet">

  <!-- Template Stylesheet -->
  <link th:href="@{css/style.css}" rel="stylesheet">
</head>

<body class="bg-body-tertiary" data-bs-theme="light">
  <div class="menu">
    <button class="hamburger-btn d-lg-none btn btn-primary text-light" onclick="toggleSidebar()">
      &#9776;
    </button>
    <!-- Sidebar Full -->
    <aside id="sidebarFull" class="sidebar-full d-none d-lg-flex flex-column flex-shrink-0 p-3 bg-body-secondary"
      style="width: 280px; min-height: 100vh;">
      <a href="/"
        class="d-flex align-items-center mb-1 mb-md-0 me-md-auto text-decoration-none link-body-emphasis fw-bold">
        <i class="fa fa-tv px-3" aria-hidden="true"></i>
        <span class="fs-4">Deco-Racks</span>
      </a>
      <hr>
      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a th:href="@{'/usuarios'}" class="nav-link" aria-current="page">
            <i class="fa fa-user me-2" aria-hidden="true"></i>
            Usuarios
          </a>
        </li>
        <li>
          <a href="/categorias" class="nav-link">
            <i class="fa-solid fa-chart-pie me-2"></i>
            Dashboard
          </a>
        </li>
        <li>
          <a th:href="@{'/categorias'}" class="nav-link">
            <i class="fa-solid fa-list me-2"></i>
            Categorias
          </a>
        </li>
        <li>
          <a href="/productos" class="nav-link">
            <i class="fa-solid fa-cart-flatbed me-2"></i>
            Productos
          </a>
        </li>
        <li>
          <a href="/stock" class="nav-link">
            <i class="fa-solid fa-box-open me-2"></i>
            Stock
          </a>
        </li>
        <li>
          <a href="/clientes" class="nav-link">
            <i class="fa-solid fa-people-group me-2"></i>
            Clientes
          </a>
        </li>
        <li>
          <a href="/pedidos" class="nav-link active">
            <i class="fa-solid fa-receipt me-2"></i>
            Pedidos
          </a>
        </li>
        <li>
          <a href="/tecnico" class="nav-link">
            <i class="fa-solid fa-people-carry-box me-2"></i>
            Asign. Tecnico
          </a>
        </li>
        <li>
          <a href="/entregas" class="nav-link">
            <i class="fa-solid fa-truck-fast me-2"></i>
            Entregas
          </a>
        </li>
      </ul>
      <hr>
      <div class="dropdown">
        <a href="#" class="d-flex align-items-center text-decoration-none link-body-emphasis dropdown-toggle"
          data-bs-toggle="dropdown" aria-expanded="false">
          <img src="https://github.com/mdo.png" alt="" width="32" height="32" class="rounded-circle me-2">
          <strong>Carlos</strong>
        </a>
        <ul class="dropdown-menu shadow border-primary">
          <li><a class="dropdown-item" href="#">Ajustes</a></li>
          <li><a class="dropdown-item" href="#">Perfil</a></li>
          <li>
            <hr class="dropdown-divider border-primary">
          </li>
          <li><a class="dropdown-item" href="#">Salir</a></li>
        </ul>
      </div>
    </aside>
    <!-- End Sidebar Full -->

    <!-- Sidebar Icon -->
    <aside id="sidebarIcons" class="sidebar-icons d-flex d-lg-none flex-column bg-body-tertiary text-center"
      style="width: 4.5rem; min-height: 100vh;">

      <a href="/" class="d-block p-3 link-body-emphasis text-decoration-none " title="Icon-only"
        data-bs-toggle="tooltip" data-bs-placement="right" onclick="toggleSidebar()">
        &#9776;
        <span class="visually-hidden">Icon-only</span>
      </a>
      <ul class="nav nav-pills nav-flush flex-column mb-auto text-center">
        <li class="nav-item">
          <a href="/usuarios" class="nav-link py-3 border-bottom rounded-0" aria-current="page" title="Usuarios"
            data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="fa fa-user" aria-hidden="true"></i>
          </a>
        </li>
        <li>
          <a href="/dashboard" class="nav-link py-3 border-bottom rounded-0" title="Dashboard" data-bs-toggle="tooltip"
            data-bs-placement="right">
            <i class="fa-solid fa-chart-pie" aria-hidden="true"></i>
          </a>
        </li>
        <li>
          <a href="/categorias" class="nav-link py-3 border-bottom rounded-0" title="Categorías"
            data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="fa-solid fa-list"></i>
          </a>
        </li>
        <li>
          <a href="/productos" class="nav-link py-3 border-bottom rounded-0" title="Productos" data-bs-toggle="tooltip"
            data-bs-placement="right">
            <i class="fa-solid fa-cart-flatbed"></i>
          </a>
        </li>
        <li>
          <a href="/stock" class="nav-link py-3 border-bottom rounded-0" title="Stock" data-bs-toggle="tooltip"
            data-bs-placement="right">
            <i class="fa-solid fa-box-open"></i>
          </a>
        </li>
        <li>
          <a href="/clientes" class="nav-link py-3 border-bottom rounded-0" title="Clientes" data-bs-toggle="tooltip"
            data-bs-placement="right">
            <i class="fa-solid fa-people-group"></i>
          </a>
        </li>
        <li>
          <a href="/pedidos" class="nav-link py-3 active border-bottom rounded-0" title="Pedidos"
            data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="fa-solid fa-receipt"></i>
          </a>
        </li>
        <li>
          <a href="/tecnico" class="nav-link py-3 border-bottom rounded-0" title="Asig. Técnico"
            data-bs-toggle="tooltip" data-bs-placement="right">
            <i class="fa-solid fa-people-carry-box"></i>
          </a>
        </li>
        <li>
          <a href="/entregas" class="nav-link py-3 border-bottom rounded-0" title="Entregas" data-bs-toggle="tooltip"
            data-bs-placement="right">
            <i class="fa-solid fa-truck-fast"></i>
          </a>
        </li>
      </ul>
      <div class="dropdown border-top">
        <a href="#"
          class="d-flex align-items-center justify-content-center p-3 link-body-emphasis text-decoration-none dropdown-toggle"
          data-bs-toggle="dropdown" aria-expanded="false">
          <img src="https://github.com/mdo.png" alt="Carlos" width="24" height="24" class="rounded-circle">
        </a>
        <ul class="dropdown-menu text-small shadow border-primary">
          <li><a class="dropdown-item" href="#">Ajustes</a></li>
          <li><a class="dropdown-item" href="#">Perfil</a></li>
          <li>
            <hr class="dropdown-divider border-primary">
          </li>
          <li><a class="dropdown-item" href="#">Salir</a></li>
        </ul>
      </div>
    </aside>
    <!-- End Sidebar Icon -->

    <div class="main-panel p-0">
      <div class="container">
        <div
          class="d-flex align-items-left align-items-md-center flex-column flex-md-row py-4 mb-1 sticky-top bg-body-tertiary border-bottom">
          <div class="text-body-emphasis">
            <h3 class="fw-bold mb-3">Pedidos</h3>
            <h6 class="mb-2">Lista de Pedidos</h6>
          </div>
          <div class="ms-md-auto py-2 py-md-0 justify-content-between row text-center">
            <div class="col">
              <a href="#" class="btn btn-outline-primary btn-round" onclick="recargarPagina()">Actualizar</a>
            </div>
            <div class="col">
              <a href="#" class="btn btn-primary btn-round link-body-emphasis text-nowrap" data-bs-toggle='modal'
                data-bs-target='#modAddOrder'>Nueva Venta</a>
            </div>
          </div>
        </div>
        <div class="container">
          <div class="card mt-3">
            <div class="card-header">
              Tabla Pedidos
            </div>
            <div class="card-body text-center text-wrap">
              <div class="table-responsive">
                <table class="table table-hover table-striped table-bordered">
                  <thead class="text-center">
                    <tr>
                      <th scope="col">Id</th>
                      <th scope="col">Fecha</th>
                      <th scope="col">Estado</th>
                      <th scope="col">Cliente</th>
                      <th scope="col">DNI</th>
                      <th scope="col">Distrito</th>
                      <th scope="col">Tecnico Asignado</th>
                      <th scope="col">Accion</th>
                    </tr>
                  </thead>
                  <tbody class="text-start table-group-divider align-middle">
                    <tr th:each="cl: ${clientes}">
                      <td th:text="${cl.id}">1</td>
                      <td th:text="${cl.fecha}">2023-01-01</td>
                      <td th:text="${cl.estado}">Pendiente</td>
                      <td th:text="${cl.cliente}">Carlos Vega</td>
                      <td th:text="${cl.dni}">55807055</td>
                      <td th:text="${cl.distrito}">San Isidro</td>
                      <td th:text="${cl.tecnico}">Juan Perez</td>
                      <td th:text="${cl.telefono}">999999999</td>
                      <td class="text-center">
                        <div class='form-button-action'>
                          <button type='button' data-bs-toggle='modal' data-bs-target='#modCustomer'
                            th:title="'Editar '+ ${cl.nombre}"
                            class='btn btn-link btn-warning btnEditarCustomer text-body-emphasis'
                            th:attr="data-id=${cl.id}, data-nombre=${cl.nombre}, data-correo=${cl.correo}, data-direccion=${cl.direccion}, data-distrito=${cl.distrito}, data-dni=${cl.dni}, data-telefono=${cl.telefono}">
                            <i class='fa fa-edit'></i>
                          </button>

                          <button type='button' data-bs-toggle='modal' data-bs-target='#modDelCustomer'
                            th:title="'Eliminar '+ ${cl.nombre}" class='btn btn-outline-danger btnDelCustomer'
                            th:attr="data-id=${cl.id}, data-nombre=${cl.nombre}">
                            <i class='fa fa-times'></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <!-- <div class="card-footer text-body-secondary">
              2 days ago
            </div> -->
          </div>
          <!-- Agregar Pedido -->
          <div class='modal fade' id='modAddOrder' tabindex='-1' aria-labelledby='mAddOrder' aria-hidden='true'
            data-bs-backdrop="static" data-bs-keyboard="false">
            <div class='modal-dialog modal-dialog-centered modal-xl'>
              <div class='modal-content text-body-emphasis'>
                <form th:action="@{/pedidos/save}" method="post">
                  <div class='modal-header'>
                    <h5 class='modal-title' id='mAddOrder'>Agregar Pedido</h5>
                    <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
                  </div>
                  <div class='modal-body'>
                    <div class='container container-fluid'>
                      <div class='row gy-3'>
                        <div class='col-12 col-lg-4'>
                          <label for='nombre'>DNI Cliente</label>
                          <div class="input-group">
                            <input type='text' class='form-control' id='dniAdd' name="dni_cliente"
                              placeholder="Ingrese DNI" required>
                            <button class="btn btn-secondary" type="button" id="button-addon1">Buscar</button>
                          </div>
                        </div>
                        <div class="col-6 col-lg-4">
                          <label for='nombre'>Nombre</label>
                          <input type='text' class='form-control-plaintext' id='nombreAdd' name='nombre'
                            placeholder="Nombre del Cliente" disabled readonly>
                        </div>
                        <div class='col-6 col-lg-4'>
                          <label for='distrito'>Distrito</label>
                          <input type="text" class="form-control-plaintext" id="distritoAdd" name="distrito"
                            placeholder="Distrito del Cliente" disabled readonly>
                        </div>
                        <div class="col-12">
                          <label for="productoSelect">Producto</label>
                          <div class="input-group mb-2">
                            <input list="productosList" id="productoSelect" class="form-control"
                              placeholder="Buscar o seleccionar producto">
                            <datalist id="productosList">
                              <option th:each="prod : ${productos}" th:value="${prod.nombre}" th:data-id="${prod.id}"
                                th:data-stock="${prod.stock}" th:data-precio="${prod.precio}"></option>
                              <option value="rack">rack</option>
                              <option value="2">Rack de Piso 42U</option>
                              <option value="3">Rack Industrial IP65</option>
                              <option value="4">Rack de Techo 12U</option>
                              <option value="5">Rack de Piso 24U</option>
                            </datalist>
                            <button class="btn btn-outline-primary" type="button"
                              id="btnAgregarProducto">Agregar</button>
                          </div>
                        </div>
                        <div class="col-md-4">
                          <label for="stockProducto">Stock</label>
                          <input type="text" class="form-control" id="stockProducto" disabled readonly>
                        </div>
                        <div class="col-md-4">
                          <label for="precioProducto">Precio Unitario</label>
                          <input type="text" class="form-control" id="precioProducto" disabled readonly>
                        </div>
                        <div class="col-md-4">
                          <label for="cantidadProducto">Cantidad</label>
                          <input type="number" class="form-control" id="cantidadProducto" min="1" value="1">
                        </div>

                        <div class="col-12">
                          <label>Productos Añadidos</label>
                          <div class="table-responsive">
                            <table class="table table-bordered table-sm align-middle mb-0" id="tablaProductosVenta">
                              <thead class="text-center">
                                <tr>
                                  <th>Producto</th>
                                  <th>Cantidad</th>
                                  <th>Precio Unitario</th>
                                  <th>Total</th>
                                  <th>Acción</th>
                                </tr>
                              </thead>
                              <tbody>
                                <!-- Aquí se agregarán dinámicamente los productos seleccionados para la venta -->
                              </tbody>
                              <tfoot>
                                <tr>
                                  <td colspan="3" class="text-end fw-bold">Total Venta:</td>
                                  <td id="totalVenta" class="fw-bold text-end">S/ 0.00</td>
                                  <td></td>
                                </tr>
                              </tfoot>
                            </table>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class='modal-footer'>
                    <button type='submit' class='btn btn-success btn-customer link-body-emphasis'>Procesar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <!-- Modificar Cliente -->
          <div class='modal fade' id='modCustomer' tabindex='-1' aria-labelledby='mCustomer' aria-hidden='true'>
            <div class='modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg'>
              <div class='modal-content text-body-emphasis'>
                <form th:action="@{/clientes/update}" method="post">
                  <div class='modal-header'>
                    <h5 class='modal-title' id='mCustomer'>Modificar Cliente</h5>
                    <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
                  </div>
                  <div class='modal-body'>
                    <div class='container container-fluid'>
                      <div class='row gy-3'>
                        <input type='hidden' name='id' value='' id='id_cliente'>
                        <div class='col-lg-6'>
                          <label for='nombre'>Nombre Cliente</label>
                          <input type='text' class='form-control' id='nombre' name="nombre_cliente"
                            placeholder="Nombre de Cliente" required>
                        </div>
                        <div class='col-md-6'>
                          <label for='correo'>Correo</label>
                          <input type='email' class='form-control' id='correo' name='correo'
                            placeholder="Correo Electrónico" required>
                        </div>
                        <div class='col-md-6'>
                          <label for='direccion'>Dirección</label>
                          <input type='text' class='form-control' id='direccion' name='direccion'
                            placeholder="Direccion" required>
                        </div>
                        <div class="col-md-6">
                          <label for='distrito'>Distrito</label>
                          <div th:replace="~{fragments/selects :: selectDistritos(idSelect='distritoEdit')}"></div>
                        </div>
                        <div class='col-md-6'>
                          <label for='dni'>DNI</label>
                          <input type='text' class='form-control' id='dniModify' name='dni'
                            placeholder="Digite DNI de Cliente" required>
                        </div>
                        <div class='col-md-6'>
                          <label for='telefono'>Celular</label>
                          <input type='text' class='form-control' id='telefonoModify' name='telefono'
                            placeholder="Teléfono">
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class='modal-footer'>
                    <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cerrar</button>
                    <button type='submit' class='btn btn-primary btn-customer'>Modificar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <!-- Eliminar cliente -->
          <div class='modal fade' id='modDelCustomer' tabindex='-1' aria-labelledby='mDelCustomer' aria-hidden='true'>
            <div class='modal-dialog modal-dialog-centered modal-dialog-scrollable'>
              <div class='modal-content text-body-emphasis'>
                <form th:action="@{/clientes/delete}" method="post">
                  <div class='modal-header'>
                    <h5 class='modal-title' id='mDelUsers'>Eliminar Cliente</h5>
                    <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
                  </div>
                  <div class='modal-body'>
                    <div class='container container-fluid text-center'>
                      <p id="nombreClienteEliminar">#Eliminar cliente</p>
                      <input type="hidden" id="id_cliente_eliminar" name="id_cliente_eliminar">
                    </div>
                  </div>
                  <div class='modal-footer'>
                    <button type='button' class='btn btn-secondary' data-bs-dismiss='modal'>Cancelar</button>
                    <button type='submit' class='btn btn-danger btn-user'>Eliminar</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
  <!-- Theme -->
  <div class="theme-container text-center mt-5">
    <div class="dropdown">
      <button class="btn btn-primary theme-btn py-2 dropdown-toggle align-items-center link-body-emphasis" type="button"
        id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i id="themeIcon" class="bi bi-moon-stars"></i>
      </button>
      <ul class="dropdown-menu shadow border-primary" aria-labelledby="themeDropdown">
        <li><a class="dropdown-item" href="#" data-theme="light"><i class="bi bi-sun"></i> Claro</a></li>
        <li><a class="dropdown-item" href="#" data-theme="dark"><i class="bi bi-moon-stars"></i> Oscuro</a></li>
        <li><a class="dropdown-item" href="#" data-theme="auto"><i class="bi bi-circle-half"></i> Según el sistema</a>
        </li>
      </ul>
    </div>
  </div>
  <!-- End Theme -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{js/themeswitcher.js}"></script>
  <script th:src="@{js/jquery-3.7.1.min.js}"></script>
  <script th:src="@{js/sidebars.js}"></script>
  <script>
    const sidebarFull = document.getElementById('sidebarFull');
    const sidebarIcon = document.getElementById('sidebarIcons');
    const mainPanel = document.querySelector('.main-panel');
    const hamburgerBtn = document.querySelector('.hamburger-btn');

    function toggleSidebar() {
      if (window.innerWidth < 768) {
        // Para móviles: mostrar u ocultar el menú completo
        sidebarFull.classList.toggle('show');
        sidebarIcon.classList.toggle('d-none');
        // OCULTAR iconos en móviles
      } else {
        mainPanel.classList.toggle('expanded');
      }
    }

    document.addEventListener('click', function (event) {
      const isClickInsideSidebar = sidebarFull.contains(event.target) || sidebarIcon.contains(event.target);
      const isClickOnButton = hamburgerBtn.contains(event.target);

      if (!isClickInsideSidebar && !isClickOnButton) {
        if (window.innerWidth < 768) {
          sidebarFull.classList.remove('show');
        } else if (window.innerWidth <= 991.98) {
          sidebarFull.classList.remove('expanded');
          sidebarIcon.classList.remove('expanded');
          mainPanel.classList.remove('expanded');
        }
      }
    });

    function adjustSidebarOnLoad() {
      if (window.innerWidth >= 768 && window.innerWidth <= 991.98) {
        // Tablet
        sidebarFull.classList.remove('expanded');
        sidebarIcon.classList.add('expanded'); // Mostrar iconos en tablet
      } else if (window.innerWidth < 768) {
        // Móvil
        sidebarFull.classList.remove('expanded');
        sidebarFull.classList.remove('show');
        sidebarIcon.classList.remove('expanded');
      } else {
        // PC
        sidebarFull.classList.add('expanded');
        sidebarIcon.classList.remove('expanded');
        mainPanel.classList.add('expanded');
      }
    }
    window.addEventListener('DOMContentLoaded', adjustSidebarOnLoad);
    window.addEventListener('resize', adjustSidebarOnLoad);
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const deleteButtons = document.querySelectorAll('.btnDelCustomer');

      deleteButtons.forEach(btn => {
        btn.addEventListener('click', function () {
          const id = this.dataset.id;
          const nombre = this.dataset.nombre;

          document.getElementById('id_cliente_eliminar').value = id;
          document.getElementById('nombreClienteEliminar').textContent = `¿Está seguro de eliminar al cliente: ${nombre}?`;
        });
      });
    });
  </script>
  <script>
    document.getElementById("button-addon1").addEventListener("click", function () {
      const dni = document.getElementById("dniAdd").value.trim();
      if (!dni) {
        alert("Ingrese un DNI");
        return;
      }

      fetch(`/clientes/buscar?dni=${dni}`)
        .then(res => {
          if (!res.ok) throw new Error("Cliente no encontrado");
          return res.json();
        })
        .then(cliente => {
          document.getElementById("nombreAdd").value = cliente.nombre;
          document.getElementById("distritoAdd").value = cliente.distrito;
        })
        .catch(err => {
          alert("No se encontró el cliente con el DNI ingresado.");
          document.getElementById("nombreAdd").value = "";
          document.getElementById("distritoAdd").value = "";
        });
    });
  </script>
</body>

</html>